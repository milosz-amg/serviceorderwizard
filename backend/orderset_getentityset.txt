METHOD orderset_get_entityset.

  DATA: lv_order_by TYPE string,
        lo_mc       TYPE REF TO /iwbep/if_message_container.

  TRY.
      DATA(lt_order_by) = io_tech_request_context->get_orderby( ).
    CATCH cx_root INTO DATA(lx_filter).
      " błądu OData
      RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
  ENDTRY.

  LOOP AT lt_order_by INTO DATA(ls_order_by).
    " Dodaj kolejne pole do ORDER BY
    IF lv_order_by IS INITIAL.
      lv_order_by = |{ ls_order_by-property }|.
    ELSE.
      lv_order_by = |{ lv_order_by }, { ls_order_by-property }|.
    ENDIF.

    IF ls_order_by-order = 'asc'.
      lv_order_by = |{ lv_order_by } ASCENDING|.
    ELSE.
      lv_order_by = |{ lv_order_by } DESCENDING|.
    ENDIF.
  ENDLOOP.


  TRY.
      SELECT *
        FROM zmr_orders
        INTO TABLE @et_entityset
        ORDER BY (lv_order_by).
      IF sy-subrc <> 0.
        lo_mc = me->/iwbep/if_mgw_conv_srv_runtime~get_message_container( ).
        lo_mc->add_message_text_only(
          iv_msg_type = /iwbep/if_message_container=>gcs_message_type-error
          iv_msg_text = |EntitySet not found or empty| ).
        RAISE EXCEPTION NEW /iwbep/cx_mgw_busi_exception( message_container = lo_mc ).
      ENDIF.
    CATCH cx_sy_open_sql_db INTO DATA(lx_sql).
      lo_mc = me->/iwbep/if_mgw_conv_srv_runtime~get_message_container( ).
      lo_mc->add_message_text_only(
        iv_msg_type = /iwbep/if_message_container=>gcs_message_type-error
        iv_msg_text = |Database connection error| ).
      RAISE EXCEPTION NEW /iwbep/cx_mgw_tech_exception( message_container = lo_mc ).
  ENDTRY.

ENDMETHOD.